name: Python Build, Test & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ CrÃ©ation du dossier build
        run: mkdir -p build

      - name: ğŸ“‚ Copier les fichiers Python dans build/
        run: |
          cp hashgestion.py build/
          cp aesgestion.py build/
          cp rsagestion.py build/
          echo "âœ… Fichiers copiÃ©s dans build/"

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build_artifacts
          path: build/
          retention-days: 7

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ TÃ©lÃ©charger les artefacts du build
        uses: actions/download-artifact@v4
        with:
          name: build_artifacts
          path: build/

      - name: ğŸ§  Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ§ª Lister les fichiers Ã  tester
        run: ls -la build/

      - name: ğŸ§© VÃ©rifier la prÃ©sence des fichiers
        run: |
          set -e
          test -f build/hashgestion.py || (echo "âŒ hashgestion.py manquant" && exit 1)
          test -f build/aesgestion.py || (echo "âŒ aesgestion.py manquant" && exit 1)
          test -f build/rsagestion.py || (echo "âŒ rsagestion.py manquant" && exit 1)
          echo "âœ… Tous les fichiers nÃ©cessaires sont prÃ©sents"

      - name: ğŸ VÃ©rification syntaxique avec py_compile
        run: |
          for file in build/*.py; do
            echo "VÃ©rification syntaxique de $file"
            python -m py_compile "$file" || (echo "âŒ Erreur dans $file" && exit 1)
          done
          echo "âœ… Aucun problÃ¨me de syntaxe trouvÃ©"

      # (Optionnel) Si tu veux des tests unitaires :
      # CrÃ©e un fichier test_hashgestion.py, etc. et dÃ©commente ci-dessous :
      # - name: ğŸ” ExÃ©cution des tests unitaires
      #   run: |
      #     pip install pytest
      #     pytest --maxfail=1 --disable-warnings -q

      - name: ğŸ“¦ Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test_artifacts
          path: build/
          retention-days: 7

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ TÃ©lÃ©charger les artefacts testÃ©s
        uses: actions/download-artifact@v4
        with:
          name: test_artifacts
          path: build/

      - name: ğŸ—‚ï¸ CrÃ©er le dossier deploy
        run: mkdir -p deploy

      - name: ğŸš€ Copier les fichiers Python dans deploy/
        run: |
          cp build/*.py deploy/
          echo "âœ… Fichiers copiÃ©s dans deploy/"

      - name: ğŸ“¦ Upload deploy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy_artifacts
          path: deploy/
          retention-days: 14

      # (Optionnel) Ã‰tape de dÃ©ploiement rÃ©el :
      # - name: ğŸš€ DÃ©ploiement sur serveur distant
      #   run: |
      #     echo "DÃ©ploiement en cours..."
      #     scp -r deploy/* user@serveur:/var/www/app
      #     echo "âœ… DÃ©ploiement terminÃ© !"
